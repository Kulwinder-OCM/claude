{% extends "base.html" %}

{% block content %}
<div class="container">
    {% if results.workflow_status == 'failed' %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Analysis Failed:</strong> {{ results.get('error', 'Unknown error occurred') }}
        </div>
    {% else %}

    <!-- Header Section -->
    <div class="text-center section-spacing">
        <h1 class="mb-3">
            <i class="fas fa-check-circle text-success me-3"></i>
            Brand Analysis Complete
        </h1>
        <p class="lead mb-3">
            Successfully analyzed <strong>{{ results.get('url', 'your website') }}</strong>
        </p>
        <div class="mb-4">
            <span class="badge bg-success fs-6 me-3">
                {{ results.workflow_status.replace('_', ' ').title() }}
            </span>
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                <i class="fas fa-plus me-2"></i>Analyze Another Site
            </a>
        </div>
    </div>

    <!-- Generated Images Section -->
    {% if images %}
    <section class="section-spacing">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    <i class="fas fa-images me-2"></i>
                    Generated Instagram Images
                </h2>
                <p class="mb-0 mt-2 opacity-75">
                    {{ images|length }} professional images ready for Instagram • Generated by Google Gemini AI
                </p>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for image in images %}
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card image-card h-100">
                            <div>
                                <img src="{{ url_for('download_image', filepath=image.filepath) }}" 
                                     class="card-img-top" alt="Instagram Post {{ image.post_number }}"
                                     style="height: 300px; object-fit: cover;">
                            </div>
                            <div class="card-body text-center">
                                <h5 class="card-title">Post {{ image.post_number }}</h5>
                                <p class="text-muted mb-3">
                                    <small>
                                        <i class="fas fa-file-image me-1"></i>{{ "%.1f"|format(image.file_size / 1024) }} KB
                                        <span class="mx-2">•</span>
                                        <i class="fas fa-expand me-1"></i>1080x1080px
                                    </small>
                                </p>
                                <a href="{{ url_for('download_image', filepath=image.filepath) }}" 
                                   class="btn btn-primary" download="{{ image.filename }}">
                                    <i class="fas fa-download me-2"></i>Download PNG
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="text-center mt-4">
                    <div class="btn-group" role="group" aria-label="Download all images">
                        {% for image in images %}
                        <a href="{{ url_for('download_image', filepath=image.filepath) }}" 
                           class="btn btn-outline-primary" download="{{ image.filename }}">
                            Post {{ image.post_number }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Analysis Results Section -->
    <section class="section-spacing">
        <div class="text-center mb-5">
            <h2>AI Analysis Results</h2>
            <p class="lead text-muted">
                Comprehensive insights generated by our AI-powered analysis
            </p>
        </div>

        <!-- Business Intelligence -->
        {% if results.phases and results.phases.get('business_intelligence') %}
        {% set bi_data = results.phases.business_intelligence.data %}
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h3 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Business Intelligence
                </h3>
                <p class="mb-0 mt-2 opacity-75">
                    <i class="fas fa-robot me-1"></i>Powered by {{ bi_data.get('ai_provider', 'AI')|title }}
                </p>
            </div>
            <div class="card-body">
                {% if bi_data.get('company_overview') and bi_data.company_overview is mapping %}
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h4><i class="fas fa-building me-2 text-info"></i>Company Overview</h4>
                        {% if bi_data.company_overview.get('name') %}
                        <p><strong>Company Name:</strong> {{ bi_data.company_overview.name }}</p>
                        {% endif %}
                        {% if bi_data.company_overview.get('industry') %}
                        <p><strong>Industry:</strong> {{ bi_data.company_overview.industry }}</p>
                        {% endif %}
                        {% if bi_data.company_overview.get('description') %}
                        <p><strong>Description:</strong></p>
                        <p class="text-muted">{{ bi_data.company_overview.description }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6 mb-4">
                        {% if bi_data.get('services_products') and bi_data.services_products is mapping %}
                        <h4><i class="fas fa-cogs me-2 text-info"></i>Services & Products</h4>
                        <p class="text-muted">{{ bi_data.services_products.get('main_offerings', 'Services and products identified through AI analysis') }}</p>
                        {% endif %}
                        
                        {% if bi_data.get('target_market') and bi_data.target_market is mapping %}
                        <h5 class="mt-4"><i class="fas fa-users me-2 text-info"></i>Target Market</h5>
                        <p class="text-muted">{{ bi_data.target_market.get('audience', 'Target audience identified through analysis') }}</p>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="alert alert-light">
                    <h5><i class="fas fa-info-circle me-2"></i>Analysis Summary</h5>
                    {% set raw_text = bi_data.get('raw_analysis', 'Business intelligence analysis completed successfully') %}

                    {# Clean up text: remove JSON braces and format as readable content #}
                    {% if '{' in raw_text and '}' in raw_text %}
                        {# Extract the descriptive text before JSON and clean it up #}
                        {% set intro_part = raw_text.split('{')[0].strip() %}

                        {# Display the intro text cleanly #}
                        {% if intro_part %}
                            <div class="mb-3">
                                <p>{{ intro_part }}</p>
                            </div>
                        {% endif %}

                        {# Extract and clean JSON content to display as readable text #}
                        {% set json_part = raw_text[raw_text.find('{'):raw_text.rfind('}')+1] %}
                        {% if json_part %}
                            <div class="p-3 bg-light rounded">
                                {% set clean_content = json_part.replace('{', '').replace('}', '').replace('"', '').replace(',', '\n').replace(':', ': ') %}
                                {% set lines = clean_content.split('\n') %}
                                {% for line in lines %}
                                    {% if line.strip() and not line.strip().startswith('main_offerings') and not line.strip().startswith('[') %}
                                        {% set clean_line = line.strip() %}
                                        {% if clean_line %}
                                            <p class="mb-1">{{ clean_line }}</p>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% else %}
                        {# Display clean text if no JSON detected #}
                        <div class="p-3 bg-light rounded">
                            <p class="mb-0">{{ raw_text }}</p>
                        </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Social Content Strategy -->
        {% if results.phases and results.phases.get('social_content') %}
        {% set social_data = results.phases.social_content.data %}
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0">
                    <i class="fas fa-bullhorn me-2"></i>Social Media Strategy
                </h3>
                <p class="mb-0 mt-2 opacity-75">
                    <i class="fas fa-robot me-1"></i>Powered by {{ social_data.get('ai_provider', 'AI')|title }}
                </p>
            </div>
            <div class="card-body">
                {% if social_data.get('brand_voice') and social_data.brand_voice is mapping %}
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h4><i class="fas fa-microphone me-2 text-success"></i>Brand Voice</h4>
                        <p><strong>Tone:</strong> {{ social_data.brand_voice.get('tone', 'Professional and engaging') }}</p>
                        <p><strong>Personality:</strong> {{ social_data.brand_voice.get('personality', 'Authentic and trustworthy') }}</p>
                        {% if social_data.brand_voice.get('messaging_style') %}
                        <p><strong>Messaging Style:</strong> {{ social_data.brand_voice.get('messaging_style') }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if social_data.get('target_audience') %}
                        <h4><i class="fas fa-users me-2 text-success"></i>Target Audience</h4>
                        {% set target_aud = social_data.target_audience %}
                        {% if target_aud %}
                            {% if target_aud is string %}
                                <p>{{ target_aud }}</p>
                            {% elif target_aud is sequence and target_aud is not string %}
                                <p>{{ target_aud|join(', ') }}</p>
                            {% else %}
                                {# Try to handle as dict, fallback to string representation #}
                                <p>{{ target_aud.primary|default(target_aud.demographics.primary|default('Business professionals and decision makers')) if target_aud is mapping else target_aud }}</p>
                            {% endif %}
                        {% endif %}
                        {% endif %}

                        {% if social_data.get('content_strategy') and social_data.content_strategy is mapping %}
                        <h5 class="mt-4"><i class="fas fa-calendar me-2 text-success"></i>Content Strategy</h5>
                        <p><strong>Posting Frequency:</strong> {{ social_data.content_strategy.get('posting_frequency', '3-4 times per week') }}</p>
                        {% if social_data.content_strategy.get('best_times') %}
                        <p><strong>Best Times:</strong> {{ social_data.content_strategy.get('best_times') }}</p>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>

                {% if social_data.get('instagram_posts') and social_data.instagram_posts is iterable %}
                <h4><i class="fas fa-instagram me-2 text-success"></i>Instagram Post Concepts</h4>
                <div class="row">
                    {% for post in social_data.instagram_posts[:3] %}
                    {% if post is mapping %}
                    <div class="col-md-4 mb-3">
                        <div class="card border-success">
                            <div class="card-body">
                                <h6 class="card-title">{{ post.get('headline', 'Post Concept') }}</h6>
                                {% set subtext = post.get('subtext', '') %}
                                <p class="card-text small text-muted">{{ subtext[:100] }}{% if subtext|length > 100 %}...{% endif %}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-success">
                                        <i class="fas fa-heart me-1"></i>{{ post.get('target_emotion', 'Engaging') }}
                                    </small>
                                    <small class="text-muted">{{ post.get('content_type', 'Social post') }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
                {% else %}
                <div class="alert alert-light">
                    <h5><i class="fas fa-check-circle me-2"></i>Strategy Generated</h5>
                    <p class="mb-0">Comprehensive social media content strategy created with AI-powered insights for maximum engagement.</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Design Analysis & Instagram Prompts -->
        <div class="row">
            <!-- Design Analysis -->
            {% if results.phases and results.phases.get('design_analysis') %}
            {% set design_data = results.phases.design_analysis.data %}
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-warning text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-palette me-2"></i>Design Analysis
                        </h4>
                        <p class="mb-0 mt-2 opacity-75">
                            <i class="fas fa-camera me-1"></i>Visual AI Analysis
                        </p>
                    </div>
                    <div class="card-body">
                        {% if design_data.get('brand_colors') and design_data.brand_colors is iterable %}
                        <h5><i class="fas fa-paint-brush me-2 text-warning"></i>Brand Colors</h5>
                        <div class="d-flex flex-wrap mb-4">
                            {% for color in design_data.brand_colors[:6] %}
                            {% if color is mapping %}
                            <div class="me-3 mb-2 text-center">
                                <div class="color-swatch" style="width: 50px; height: 50px; background-color: {{ color.get('hex', '#000') }}; border-radius: 8px;"></div>
                                <small class="d-block mt-1 fw-bold">{{ color.get('hex', '#000') }}</small>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% if design_data.get('typography') and design_data.typography is mapping %}
                        <h5><i class="fas fa-font me-2 text-warning"></i>Typography</h5>
                        <p><strong>Font Style:</strong> {{ design_data.typography.get('primary_font', 'Modern sans-serif typography') }}</p>
                        {% endif %}

                        {% if design_data.get('layout_style') and design_data.layout_style is mapping %}
                        <h5><i class="fas fa-th-large me-2 text-warning"></i>Layout Style</h5>
                        <p class="text-muted">{{ design_data.layout_style.get('description', 'Clean, professional layout with modern design elements and structured information hierarchy') }}</p>
                        {% endif %}

                        {% if not design_data.get('brand_colors') and not design_data.get('typography') %}
                        <div class="alert alert-light">
                            <h6><i class="fas fa-check-circle me-2"></i>Analysis Complete</h6>
                            <p class="mb-0 small">Website design analyzed for visual elements, color schemes, typography, and layout patterns.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Instagram Prompts -->
            {% if results.phases and results.phases.get('instagram_prompts') %}
            {% set prompts_data = results.phases.instagram_prompts.data %}
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-secondary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-lightbulb me-2"></i>AI Prompts
                        </h4>
                        <p class="mb-0 mt-2 opacity-75">
                            {{ prompts_data.get('total_prompts', 3) }} prompts created for Gemini
                        </p>
                    </div>
                    <div class="card-body">
                        {% if prompts_data.get('prompts') and prompts_data.prompts is iterable %}
                        {% for prompt in prompts_data.prompts[:3] %}
                        {% if prompt is mapping %}
                        <div class="mb-3 p-3 border rounded">
                            <h6 class="text-secondary mb-2">
                                <i class="fas fa-image me-2"></i>{{ prompt.get('headline', 'Prompt ' + loop.index|string) }}
                            </h6>
                            <div class="small text-muted">
                                <strong>Concept:</strong> {{ prompt.get('concept', 'Brand') }}<br>
                                <strong>Emotion:</strong> {{ prompt.get('target_emotion', 'Engaging') }}<br>
                                <strong>Type:</strong> {{ prompt.get('content_type', 'Instagram post') }}
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                        {% else %}
                        <div class="alert alert-light">
                            <h6><i class="fas fa-check-circle me-2"></i>Prompts Generated</h6>
                            <p class="mb-0 small">Professional AI prompts created and optimized for high-quality image generation.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </section>

    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add download animation
    const downloadButtons = document.querySelectorAll('a[download]');
    downloadButtons.forEach(button => {
        button.addEventListener('click', function() {
            const icon = this.querySelector('i.fa-download');
            if (icon) {
                icon.classList.remove('fa-download');
                icon.classList.add('fa-check');
                setTimeout(() => {
                    icon.classList.remove('fa-check');
                    icon.classList.add('fa-download');
                }, 2000);
            }
        });
    });
});
</script>
{% endblock %}